@page
@model eWorldCup.Presentation.Pages.TournamentModel
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tournament of Power</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: #fff; padding: 25px 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,.08); }
        h1 { text-align: center; margin-top: 0; }
        .row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
        label { font-weight: bold; }
        input[type=number] { padding: 6px 8px; width: 90px; }
        button { cursor: pointer; border: none; padding: 8px 14px; color: #fff; border-radius: 4px; }
        .b1 { background:#e74c3c;} .b2 {background:#f39c12;} .b3 {background:#27ae60;} .b4 {background:#9b59b6;} .b5 {background:#3498db;}
        button:hover { opacity:.9; }
        .msg { padding:10px 14px; border-radius:4px; margin:15px 0; }
        .ok { background:#d5f4e6; color:#1d6b46; border-left:4px solid #27ae60; }
        .err { background:#fadbd8; color:#7d1d18; border-left:4px solid #e74c3c; }
        .result-block { background:#eef6ff; padding:12px 14px; border-left:4px solid #3498db; margin:10px 0; border-radius:4px; }
        .pairs { display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px; margin-top:15px; }
        .pair { background:#ecf0f1; padding:10px 12px; border-radius:6px; font-weight:bold; display:flex; align-items:center; gap:8px; }
        .pair img { width:34px; height:34px; border-radius:50%; object-fit:cover; border:2px solid #fff; box-shadow:0 0 0 2px #3498db; }
        .vs { font-size:11px; font-weight:normal; color:#555; margin:0 4px; }
        .avatar-inline { width:30px; height:30px; border-radius:50%; object-fit:cover; vertical-align:middle; margin-right:6px; border:2px solid #fff; box-shadow:0 0 0 2px #9b59b6; }
        .direct-match-line { display:flex; align-items:center; gap:8px; }
        hr { margin:30px 0 20px; }
        pre { white-space:pre-wrap; font-size:12px; background:#fafafa; padding:10px; border:1px solid #eee; border-radius:4px; }
    </style>
</head>
<body>
<div class="container">
    <h1> Tournament of Power</h1>

    <div id="message"></div>

    <div class="section" id="section-generate">
        <div class="section-header"><h2>Generate Round Pairs</h2></div>
        <div class="row">
            <label for="roundInput">Round:</label>
            <input id="roundInput" type="number" min="1" max="11" value="1" />
            <button class="b1" id="btnGenerate">Generate</button>
        </div>
        <div id="pairsResult" style="display:none;">
            <div class="result-block" id="pairsHeader"></div>
            <div class="pairs" id="pairsContainer"></div>
        </div>
    </div>

    <hr />

    <div class="section" id="section-max">
        <h2>Max Rounds</h2>
        <div class="row">
            <label for="participantCountInput">Participants:</label>
            <input id="participantCountInput" type="number" min="2" value="12" />
            <button class="b2" id="btnMaxRounds">Calc</button>
        </div>
        <div id="maxRoundsResult" class="result-block" style="display:none;"></div>
    </div>

    <hr />

    <div class="section" id="section-remaining">
        <h2>Remaining Pairs</h2>
        <div class="row">
            <label for="participantCountInput2">Participants:</label>
            <input id="participantCountInput2" type="number" min="2" value="12" />
            <label for="roundsPlayedInput">Rounds Played:</label>
            <input id="roundsPlayedInput" type="number" min="0" value="0" />
            <button class="b3" id="btnRemainingPairs">Calc</button>
        </div>
        <div id="remainingPairsResult" class="result-block" style="display:none;"></div>
    </div>

    <hr />

    <div class="section" id="section-direct">
        <h2>Direct Match</h2>
        <div class="row">
            <label for="playerIndexInput">Player Index:</label>
            <input id="playerIndexInput" type="number" min="0" max="11" value="0" />
            <label for="directMatchRoundInput">Round:</label>
            <input id="directMatchRoundInput" type="number" min="1" max="11" value="1" />
            <button class="b4" id="btnDirectMatch">Find</button>
        </div>
        <div id="directMatchResult" class="result-block" style="display:none;"></div>
    </div>

    <hr />

    <div class="section" id="section-quicktest">
        <h2>Quick Test All Features</h2>
        <div class="row">
            <button class="b5" id="btnTestAll">Run All Tests</button>
        </div>
        <pre id="testLog" style="display:none;"></pre>
    </div>
</div>
<script>
(function(){
    const apiBase = '/api/tournament';
    let participants = [];

    const el = id => document.getElementById(id);
    const message = el('message');

    function showMessage(text, ok=true){
        message.innerHTML = `<div class="msg ${ok? 'ok':'err'}">${text}</div>`;
    }

    async function apiGet(url){
        const res = await fetch(url, { headers: { 'Accept':'application/json' }});
        if(!res.ok) throw new Error(await res.text() || res.statusText);
        return res.json();
    }

    async function apiPost(url, body){
        const res = await fetch(url, {
            method:'POST',
            headers:{ 'Content-Type':'application/json','Accept':'application/json' },
            body: JSON.stringify(body)
        });
        if(!res.ok) throw new Error(await res.text() || res.statusText);
        return res.json();
    }

    function findParticipantByName(name){
        return participants.find(p => p.name === name) || {};
    }

    async function loadParticipants(){
        try {
            participants = await apiGet(`${apiBase}/participants`);
            showMessage('Participants loaded.', true);
        } catch(err){
            showMessage('Failed to load participants: ' + err.message, false);
        }
    }

    function unwrapPairs(result){
        // Accept {pairs:[...]}, {Pairs:[...]}, or direct array fallback
        const arr = result?.pairs || result?.Pairs || result;
        if(!Array.isArray(arr)) throw new Error('Unexpected pairs response format.');
        return arr;
    }

    // Generate Pairs
    el('btnGenerate').addEventListener('click', async ()=>{
        const round = parseInt(el('roundInput').value,10);
        try {
            if (participants.length === 0) await loadParticipants();
            const result = await apiPost(`${apiBase}/round`, { round, participants });
            const pairs = unwrapPairs(result);

            const container = el('pairsContainer');
            container.innerHTML = '';
            pairs.forEach(pair=>{
                const pa = findParticipantByName(pair.participantA);
                const pb = findParticipantByName(pair.participantB);
                const d = document.createElement('div');
                d.className='pair';
                d.innerHTML =
                    `<img src="${pa.imageUrl || ''}" alt="${pair.participantA}" title="${pair.participantA}" />` +
                    `<span>${pair.participantA}</span> <span class='vs'>vs</span>` +
                    `<img src="${pb.imageUrl || ''}" alt="${pair.participantB}" title="${pair.participantB}" />` +
                    `<span>${pair.participantB}</span>`;
                container.appendChild(d);
            });
            el('pairsHeader').textContent = `Pairs for round ${round}`;
            el('pairsResult').style.display='block';
            showMessage(`Generated ${pairs.length} pairs for round ${round}`);
        } catch(err){ showMessage(err.message, false); }
    });

    // Max Rounds
    el('btnMaxRounds').addEventListener('click', async ()=>{
        const pc = parseInt(el('participantCountInput').value,10);
        try {
            const data = await apiGet(`${apiBase}/max-rounds?participantCount=${pc}`);
            el('maxRoundsResult').style.display='block';
            el('maxRoundsResult').innerHTML = `Max Rounds: <strong>${data.maxNumRounds}</strong>`;
            showMessage(`Calculated max rounds (${data.maxNumRounds}) for ${pc} participants.`);
        } catch(err){ showMessage(err.message, false); }
    });

    // Remaining Pairs
    el('btnRemainingPairs').addEventListener('click', async ()=>{
        const pc = parseInt(el('participantCountInput2').value,10);
        const rp = parseInt(el('roundsPlayedInput').value,10);
        try {
            const data = await apiGet(`${apiBase}/remaining-pairs?participantCount=${pc}&roundsPlayed=${rp}`);
            el('remainingPairsResult').style.display='block';
            el('remainingPairsResult').innerHTML = `Remaining Pairs: <strong>${data.remainingPairs}</strong>`;
            showMessage(`Remaining pairs: ${data.remainingPairs}`);
        } catch(err){ showMessage(err.message, false); }
    });

    // Direct Match
    el('btnDirectMatch').addEventListener('click', async ()=>{
        const playerIndex = parseInt(el('playerIndexInput').value,10);
        const round = parseInt(el('directMatchRoundInput').value,10);
        try {
            if (participants.length === 0) await loadParticipants();
            const body = { participantCount: participants.length, playerIndex, round, participants };
            const data = await apiPost(`${apiBase}/direct-match`, body);
            const pa = participants[playerIndex];
            const opponent = participants.find(p => p.name === data.opponent);
            el('directMatchResult').style.display='block';
            el('directMatchResult').innerHTML =
                `<div class='direct-match-line'>`+
                `<img class='avatar-inline' src='${pa.imageUrl || ''}' alt='${pa.name}' />`+
                `<strong>${data.player}</strong> vs <img class='avatar-inline' src='${opponent?.imageUrl || ''}' alt='${data.opponent}' /> <strong>${data.opponent}</strong>`+
                `</div>`;
            showMessage(`${data.player} fights ${data.opponent} in round ${round}`);
        } catch(err){ showMessage(err.message, false); }
    });

    // Quick Test All
    el('btnTestAll').addEventListener('click', async ()=>{
        const logEl = el('testLog');
        logEl.style.display='block';
        logEl.textContent = 'Running tests...\n';
        function log(t){ logEl.textContent += t + '\n'; }
        try {
            if (participants.length === 0) await loadParticipants();
            const max = await apiGet(`${apiBase}/max-rounds?participantCount=${participants.length}`);
            log(`MaxRounds OK -> ${max.maxNumRounds}`);
            const rem = await apiGet(`${apiBase}/remaining-pairs?participantCount=${participants.length}&roundsPlayed=3`);
            log(`RemainingPairs OK -> ${rem.remainingPairs}`);
            const dm = await apiPost(`${apiBase}/direct-match`, { participantCount: participants.length, playerIndex:0, round:1, participants });
            log(`DirectMatch OK -> ${dm.player} vs ${dm.opponent}`);
            const prsResult = await apiPost(`${apiBase}/round`, { round:1, participants });
            const pairs = unwrapPairs(prsResult);
            log(`Pairs OK -> ${pairs.length} pairs`);
            showMessage('All tests completed successfully.');
        } catch(err){
            log('Error: ' + err.message);
            showMessage('One or more tests failed: ' + err.message, false);
        }
    });

    // Initial load
    loadParticipants();
})();
</script>
</body>
</html>